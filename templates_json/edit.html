<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Game - {{ pid }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-content {
            flex: 1;
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .pid {
            color: #666;
            font-size: 14px;
        }

        .nav-arrow {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #00d9ff 0%, #00b4d8 100%);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 180, 216, 0.3);
        }

        .nav-arrow:hover:not(:disabled) {
            background: linear-gradient(135deg, #00b4d8 0%, #0096c7 100%);
            transform: scale(1.05);
        }

        .nav-arrow:disabled {
            background: #e0e0e0;
            cursor: not-allowed;
            box-shadow: none;
        }

        .nav-arrow svg {
            width: 24px;
            height: 24px;
            fill: white;
        }

        .nav-arrow:disabled svg {
            fill: #999;
        }

        .tabs {
            display: flex;
            gap: 10px;
            background: white;
            padding: 10px 20px 0;
            border-radius: 8px 8px 0 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .tab {
            padding: 12px 24px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab:hover:not(.disabled) {
            background: #e0e0e0;
        }

        .tab.active {
            background: white;
            color: #667eea;
        }

        .tab.disabled {
            color: #ccc;
            cursor: not-allowed;
        }

        .tab.xbox-enabled,
        .tab.igdb-enabled {
            color: #666;
            background: #f0f0f0;
            cursor: pointer;
        }

        .tab.xbox-enabled:hover,
        .tab.igdb-enabled:hover {
            background: #e0e0e0;
        }

        .tab.xbox-enabled.active,
        .tab.igdb-enabled.active {
            background: white;
            color: #667eea;
        }

        .content {
            background: white;
            padding: 30px;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 400px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="text"]:disabled {
            background: #f5f5f5;
            color: #666;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .readonly-field {
            background: #f9f9f9;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            color: #666;
            font-size: 14px;
        }

        .save-button {
            background: #10b981;
            color: white;
            padding: 14px 32px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 20px;
        }

        .save-button:hover {
            background: #059669;
        }

        .save-button:active {
            transform: scale(0.98);
        }

        .vscode-button {
            background: #5110b9;
            color: white;
            padding: 14px 32px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 20px;
        }

        .vscode-button:hover {
            background: #3f0c92;
        }

        .vscode-button:active {
            transform: scale(0.98);
        }

        .availability-period {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fafafa;
        }

        .availability-period h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .tier-entry {
            background: white;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }

        .tier-row {
            display: grid;
            grid-template-columns: 200px 1fr 1fr;
            gap: 15px;
            align-items: end;
        }

        select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
        }

        .add-tier-btn,
        .add-period-btn {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }

        .add-tier-btn:hover,
        .add-period-btn:hover {
            background: #5568d3;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: #10b981;
        }

        .notification.error {
            background: #ef4444;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .igdb-section {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .igdb-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .igdb-field {
            margin-bottom: 12px;
        }

        .igdb-field-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .igdb-field-value {
            color: #666;
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .igdb-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .igdb-list-item {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 13px;
        }

        .igdb-update-section {
            background: #fff;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }

        .igdb-update-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .igdb-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .igdb-input-box {
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            background: #fafafa;
        }

        .igdb-input-box h4 {
            color: #333;
            font-size: 14px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .igdb-input-box input {
            width: 100%;
        }

        .igdb-submit {
            background: #667eea;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }

        .igdb-submit:hover {
            background: #5568d3;
        }

        .no-data-message {
            text-align: center;
            color: #999;
            padding: 40px;
            font-style: italic;
        }

        .xbox-section {
            background: #f9f9f9;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .xbox-section h3 {
            color: #107c10;
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid #107c10;
            padding-bottom: 8px;
        }

        .xbox-field {
            margin-bottom: 12px;
        }

        .xbox-field-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .xbox-field-value {
            color: #666;
            padding: 8px 12px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }

        .xbox-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .xbox-list-item {
            background: #107c10;
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 13px;
        }
    </style>
</head>

<body>
    <div class="header">
        <button class="nav-arrow" onclick="navigateTo('{{ prev_pid }}')" {{ 'disabled' if not prev_pid else '' }}>
            <svg viewBox="0 0 24 24">
                <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
            </svg>
        </button>

        <div class="header-content">
            <h1>{{ data.basic_info.title }}</h1>
            <div class="pid">Product ID: {{ pid }}</div>
        </div>

        <button class="nav-arrow" onclick="navigateTo('{{ next_pid }}')" {{ 'disabled' if not next_pid else '' }}>
            <svg viewBox="0 0 24 24">
                <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
            </svg>
        </button>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="switchTab('basic_info')">Basic Info</button>
        <button class="tab" onclick="switchTab('availabilities')">Availabilities</button>
        <button class="tab" onclick="switchTab('flags')">Flags</button>
        <button class="tab xbox-enabled" onclick="switchTab('xbox_store')">Xbox Store</button>
        <button class="tab disabled">Steam</button>
        <button class="tab igdb-enabled" onclick="switchTab('igdb')">IGDB</button>
    </div>

    <div class="content">
        <!-- Basic Info Tab -->
        <div id="basic_info" class="tab-content active">
            <div class="form-group">
                <label>Product ID (Read-only)</label>
                <div class="readonly-field">{{ data.basic_info.pid }}</div>
            </div>

            <div class="form-group">
                <label>Store Title (Read-only)</label>
                <div class="readonly-field">{{ data.basic_info.store_title }}</div>
            </div>

            <div class="form-group">
                <label>Base ID</label>
                <input type="number" id="base_id" value="{{ data.basic_info.base_id }}">
            </div>

            <div class="form-group">
                <label>Specific ID</label>
                <input type="number" id="specific_id" value="{{ data.basic_info.specific_id }}">
            </div>

            <div class="form-group">
                <label>Title</label>
                <input type="text" id="title" value="{{ data.basic_info.title }}">
            </div>

            <div class="form-group">
                <label>Original Release Date (Propagates to related SKUs)</label>
                <input type="date" id="original_release_date" value="{{ data.basic_info.original_release_date or '' }}">
            </div>

            <div class="form-group">
                <label>Release Date (SKU-specific)</label>
                <input type="date" id="release_date" value="{{ data.basic_info.release_date or '' }}">
            </div>

            <div class="form-group">
                <label>Platforms</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="platform_pc" value="PC" {{ 'checked' if 'PC' in
                            data.basic_info.platforms else '' }}>
                        <label for="platform_pc">PC</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="platform_xboxone" value="XboxOne" {{ 'checked' if 'XboxOne' in
                            data.basic_info.platforms else '' }}>
                        <label for="platform_xboxone">Xbox One</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="platform_xboxseriesx" value="XboxSeriesX" {{ 'checked'
                            if 'XboxSeriesX' in data.basic_info.platforms else '' }}>
                        <label for="platform_xboxseriesx">Xbox Series X</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="platform_xcloud" value="XCloud" {{ 'checked' if 'XCloud' in
                            data.basic_info.platforms else '' }}>
                        <label for="platform_xcloud">XCloud</label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Related SKUs (Read-only)</label>
                <div class="readonly-field">
                    {% for sku_id in data.basic_info.related_skus %}
                    <a href="{{ url_for('edit', pid=sku_id) }}" class="sku-link">{{ sku_id }}</a>
                    {% endfor %}
                </div>
            </div>

            <style>
                .sku-link {
                    display: inline-block;
                    margin: 2px 4px;
                    padding: 4px 8px;
                    background-color: #f3f3f3;
                    border-radius: 4px;
                    text-decoration: none;
                    color: #007bff;
                    transition: background 0.2s;
                }

                .sku-link:hover {
                    background-color: #e2e6ea;
                }
            </style>

            <div class="form-group">
                <label>Alternate Xbox ID (Read-only)</label>
                <div class="readonly-field">{{ data.basic_info.alternate_xbox_id or 'None' }}</div>
            </div>

            <button class="save-button" onclick="saveBasicInfo()">Save</button>
            <button class="vscode-button" onclick="openInVSCode('{{ pid }}')">Open in VS Code</button>
        </div>

        <!-- Availabilities Tab -->
        <div id="availabilities" class="tab-content">
            <div id="availability-container"></div>
            <button class="add-period-btn" onclick="addAvailabilityPeriod()">Add Availability Period</button>
            <button class="save-button" onclick="saveAvailabilities()">Save</button>
        </div>

        <!-- Flags Tab -->
        <div id="flags" class="tab-content">
            <div class="form-group">
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="flag_indie" {{ 'checked' if data.flags.indie else '' }}>
                        <label for="flag_indie">Indie</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="flag_first_party" {{ 'checked' if data.flags.first_party else '' }}>
                        <label for="flag_first_party">First Party</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="flag_f2p" {{ 'checked' if data.flags.f2p else '' }}>
                        <label for="flag_f2p">Free to Play</label>
                    </div>
                </div>
            </div>

            <button class="save-button" onclick="saveFlags()">Save</button>
        </div>

        <!-- Xbox Store Tab -->
        <div id="xbox_store" class="tab-content">
            {% if data.xbox_store_meta %}
            <div class="xbox-section">
                <h3>Xbox Store Metadata</h3>

                {% if data.xbox_store_meta.publisher %}
                <div class="xbox-field">
                    <div class="xbox-field-label">Publisher</div>
                    <div class="xbox-field-value">{{ data.xbox_store_meta.publisher }}</div>
                </div>
                {% endif %}

                {% if data.xbox_store_meta.developer %}
                <div class="xbox-field">
                    <div class="xbox-field-label">Developer</div>
                    <div class="xbox-field-value">{{ data.xbox_store_meta.developer }}</div>
                </div>
                {% endif %}

                {% if data.xbox_store_meta.capabilities %}
                <div class="xbox-field">
                    <div class="xbox-field-label">Capabilities</div>
                    <div class="xbox-list">
                        {% for capability in data.xbox_store_meta.capabilities.values() %}
                        <span class="xbox-list-item">{{ capability }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if data.xbox_store_meta.categories %}
                <div class="xbox-field">
                    <div class="xbox-field-label">Categories</div>
                    <div class="xbox-list">
                        {% for category in data.xbox_store_meta.categories %}
                        <span class="xbox-list-item">{{ category }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="no-data-message">No Xbox Store metadata available</div>
            {% endif %}
        </div>

        <!-- IGDB Tab -->
        <div id="igdb" class="tab-content">
            {% if data.igdb_meta %}
            {% if data.igdb_meta.main %}
            <div class="igdb-section">
                <h3>Main Game Data</h3>

                <div class="igdb-field">
                    <div class="igdb-field-label">IGDB ID</div>
                    <div class="igdb-field-value">{{ data.igdb_meta.main.id }}</div>
                </div>

                <div class="igdb-field">
                    <div class="igdb-field-label">Name</div>
                    <div class="igdb-field-value">{{ data.igdb_meta.main.name }}</div>
                </div>

                <div class="igdb-field">
                    <div class="igdb-field-label">URL</div>
                    <div class="igdb-field-value">
                        <a href="{{ data.igdb_meta.main.url }}" target="_blank" style="color: #667eea;">{{
                            data.igdb_meta.main.url }}</a>
                    </div>
                </div>

                {% if data.igdb_meta.main.publishers %}
                <div class="igdb-field">
                    <div class="igdb-field-label">Publishers</div>
                    <div class="igdb-list">
                        {% for publisher in data.igdb_meta.main.publishers %}
                        <span class="igdb-list-item">{{ publisher }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if data.igdb_meta.main.developers %}
                <div class="igdb-field">
                    <div class="igdb-field-label">Developers</div>
                    <div class="igdb-list">
                        {% for developer in data.igdb_meta.main.developers %}
                        <span class="igdb-list-item">{{ developer }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if data.igdb_meta.main.genres %}
                <div class="igdb-field">
                    <div class="igdb-field-label">Genres</div>
                    <div class="igdb-list">
                        {% for genre in data.igdb_meta.main.genres %}
                        <span class="igdb-list-item">{{ genre }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if data.igdb_meta.main.themes %}
                <div class="igdb-field">
                    <div class="igdb-field-label">Themes</div>
                    <div class="igdb-list">
                        {% for theme in data.igdb_meta.main.themes %}
                        <span class="igdb-list-item">{{ theme }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if data.igdb_meta.main.game_modes %}
                <div class="igdb-field">
                    <div class="igdb-field-label">Game Modes</div>
                    <div class="igdb-list">
                        {% for mode in data.igdb_meta.main.game_modes %}
                        <span class="igdb-list-item">{{ mode }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if data.igdb_meta.main.player_perspectives %}
                <div class="igdb-field">
                    <div class="igdb-field-label">Player Perspectives</div>
                    <div class="igdb-list">
                        {% for perspective in data.igdb_meta.main.player_perspectives %}
                        <span class="igdb-list-item">{{ perspective }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if data.igdb_meta.specific %}
            <div class="igdb-section">
                <h3>Specific Edition Data</h3>

                <div class="igdb-field">
                    <div class="igdb-field-label">IGDB ID</div>
                    <div class="igdb-field-value">{{ data.igdb_meta.specific.id }}</div>
                </div>

                <div class="igdb-field">
                    <div class="igdb-field-label">Name</div>
                    <div class="igdb-field-value">{{ data.igdb_meta.specific.name }}</div>
                </div>

                <div class="igdb-field">
                    <div class="igdb-field-label">URL</div>
                    <div class="igdb-field-value">
                        <a href="{{ data.igdb_meta.specific.url }}" target="_blank" style="color: #667eea;">{{
                            data.igdb_meta.specific.url }}</a>
                    </div>
                </div>

                {% if data.igdb_meta.specific.publishers %}
                <div class="igdb-field">
                    <div class="igdb-field-label">Publishers</div>
                    <div class="igdb-list">
                        {% for publisher in data.igdb_meta.specific.publishers %}
                        <span class="igdb-list-item">{{ publisher }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if data.igdb_meta.specific.developers %}
                <div class="igdb-field">
                    <div class="igdb-field-label">Developers</div>
                    <div class="igdb-list">
                        {% for developer in data.igdb_meta.specific.developers %}
                        <span class="igdb-list-item">{{ developer }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if data.igdb_meta.specific.genres %}
                <div class="igdb-field">
                    <div class="igdb-field-label">Genres</div>
                    <div class="igdb-list">
                        {% for genre in data.igdb_meta.specific.genres %}
                        <span class="igdb-list-item">{{ genre }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if data.igdb_meta.specific.themes %}
                <div class="igdb-field">
                    <div class="igdb-field-label">Themes</div>
                    <div class="igdb-list">
                        {% for theme in data.igdb_meta.specific.themes %}
                        <span class="igdb-list-item">{{ theme }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if data.igdb_meta.specific.game_modes %}
                <div class="igdb-field">
                    <div class="igdb-field-label">Game Modes</div>
                    <div class="igdb-list">
                        {% for mode in data.igdb_meta.specific.game_modes %}
                        <span class="igdb-list-item">{{ mode }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if data.igdb_meta.specific.player_perspectives %}
                <div class="igdb-field">
                    <div class="igdb-field-label">Player Perspectives</div>
                    <div class="igdb-list">
                        {% for perspective in data.igdb_meta.specific.player_perspectives %}
                        <span class="igdb-list-item">{{ perspective }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if not data.igdb_meta.main and not data.igdb_meta.specific %}
            <div class="no-data-message">No IGDB data available</div>
            {% endif %}
            {% else %}
            <div class="no-data-message">No IGDB data available</div>
            {% endif %}

            <div class="igdb-update-section">
                <h3>Update IGDB Data</h3>
                <div class="igdb-input-group">
                    <div class="igdb-input-box">
                        <h4>Main Game ID</h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Enter the IGDB ID for the main game
                            entry</p>
                        <input type="number" id="igdb_main_id" placeholder="e.g., 4796">
                        <button class="igdb-submit" onclick="updateIGDB(true)">Update Main</button>
                    </div>
                    <div class="igdb-input-box">
                        <h4>Specific Edition ID</h4>
                        <p style="font-size: 12px; color: #666; margin-bottom: 8px;">Enter the IGDB ID for this specific
                            edition</p>
                        <input type="number" id="igdb_specific_id" placeholder="e.g., 4796">
                        <button class="igdb-submit" onclick="updateIGDB(false)">Update Specific</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const gameData = {{ data | tojson }};
        const tierNames = {{ tier_names | tojson }};

        function navigateTo(pid) {
            if (pid && pid !== 'None') {
                window.location.href = `/edit/${pid}`;
            }
        }

        function switchTab(tabName) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Add active class to clicked tab and corresponding content
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function saveBasicInfo() {
            const platforms = [];
            if (document.getElementById('platform_pc').checked) platforms.push('PC');
            if (document.getElementById('platform_xboxone').checked) platforms.push('XboxOne');
            if (document.getElementById('platform_xboxseriesx').checked) platforms.push('XboxSeriesX');
            if (document.getElementById('platform_xcloud').checked) platforms.push('XCloud');

            const data = {
                tab: 'basic_info',
                base_id: parseInt(document.getElementById('base_id').value) || null,
                specific_id: parseInt(document.getElementById('specific_id').value) || null,
                title: document.getElementById('title').value,
                original_release_date: document.getElementById('original_release_date').value || null,
                release_date: document.getElementById('release_date').value || null,
                platforms: platforms
            };

            fetch(`/api/save/{{ pid }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showNotification('Basic info saved successfully!');
                    } else {
                        showNotification('Error: ' + result.error, 'error');
                    }
                })
                .catch(error => {
                    showNotification('Error saving data: ' + error, 'error');
                });
        }

        function renderAvailabilities() {
            const container = document.getElementById('availability-container');
            container.innerHTML = '';

            gameData.availabilities.forEach((period, periodIndex) => {
                const periodDiv = document.createElement('div');
                periodDiv.className = 'availability-period';
                periodDiv.innerHTML = `<h3>Availability Period ${periodIndex + 1}</h3>`;

                Object.entries(period).forEach(([tier, dates]) => {
                    const tierDiv = document.createElement('div');
                    tierDiv.className = 'tier-entry';
                    tierDiv.innerHTML = `
                        <div class="tier-row">
                            <div class="form-group">
                                <label>Tier</label>
                                <select class="tier-select" data-period="${periodIndex}" data-tier="${tier}">
                                    ${tierNames.map(t => `<option value="${t}" ${t === tier ? 'selected' : ''}>${t}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Added</label>
                                <input type="date" class="tier-added" data-period="${periodIndex}" data-tier="${tier}" value="${dates.added || ''}">
                            </div>
                            <div class="form-group">
                                <label>Removed</label>
                                <input type="date" class="tier-removed" data-period="${periodIndex}" data-tier="${tier}" value="${dates.removed || ''}" onchange="propagateRemoved(${periodIndex}, this.value)">
                            </div>
                        </div>
                    `;
                    periodDiv.appendChild(tierDiv);
                });

                const addTierBtn = document.createElement('button');
                addTierBtn.className = 'add-tier-btn';
                addTierBtn.textContent = 'Add Tier';
                addTierBtn.onclick = () => addTierToPeriod(periodIndex);
                periodDiv.appendChild(addTierBtn);

                container.appendChild(periodDiv);
            });
        }

        function propagateRemoved(periodIndex, value) {
            document.querySelectorAll(`.tier-removed[data-period="${periodIndex}"]`).forEach(input => {
                input.value = value;
            });
        }

        function syncAvailabilitiesFromDOM() {
            // Loop through all current availability periods
            document.querySelectorAll('.availability-period').forEach((periodDiv, periodIndex) => {
                const period = {};

                // For each tier entry inside this period
                periodDiv.querySelectorAll('.tier-entry').forEach(tierDiv => {
                    const select = tierDiv.querySelector('.tier-select');
                    const added = tierDiv.querySelector('.tier-added');
                    const removed = tierDiv.querySelector('.tier-removed');

                    const tierName = select.value;
                    period[tierName] = {
                        added: added.value || null,
                        removed: removed.value || null
                    };
                });

                // Store updated data back into gameData
                gameData.availabilities[periodIndex] = period;
            });
        }

        function addTierToPeriod(periodIndex) {
            syncAvailabilitiesFromDOM(); // preserve current values first

            const availableTiers = tierNames.filter(
                tier => !gameData.availabilities[periodIndex].hasOwnProperty(tier)
            );

            if (availableTiers.length === 0) {
                showNotification('All tiers already added to this period', 'error');
                return;
            }

            // Add a new blank tier
            gameData.availabilities[periodIndex][availableTiers[0]] = {
                added: null,
                removed: null
            };

            renderAvailabilities();
        }

        function addAvailabilityPeriod() {
            syncAvailabilitiesFromDOM(); // preserve current values first
            gameData.availabilities.push({});
            renderAvailabilities();
        }

        function saveAvailabilities() {
            const availabilities = [];

            document.querySelectorAll('.availability-period').forEach((periodDiv, periodIndex) => {
                const period = {};

                periodDiv.querySelectorAll('.tier-entry').forEach(tierDiv => {
                    const select = tierDiv.querySelector('.tier-select');
                    const added = tierDiv.querySelector('.tier-added');
                    const removed = tierDiv.querySelector('.tier-removed');

                    const tierName = select.value;
                    period[tierName] = {
                        added: added.value || null,
                        removed: removed.value || null
                    };
                });

                availabilities.push(period);
            });

            const data = {
                tab: 'availabilities',
                availabilities: availabilities
            };

            fetch(`/api/save/{{ pid }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showNotification('Availabilities saved successfully!');
                    } else {
                        showNotification('Error: ' + result.error, 'error');
                    }
                })
                .catch(error => {
                    showNotification('Error saving data: ' + error, 'error');
                });
        }

        function saveFlags() {
            const data = {
                tab: 'flags',
                flags: {
                    indie: document.getElementById('flag_indie').checked,
                    first_party: document.getElementById('flag_first_party').checked,
                    f2p: document.getElementById('flag_f2p').checked
                }
            };

            fetch(`/api/save/{{ pid }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showNotification('Flags saved successfully!');
                    } else {
                        showNotification('Error: ' + result.error, 'error');
                    }
                })
                .catch(error => {
                    showNotification('Error saving data: ' + error, 'error');
                });
        }

        function updateIGDB(isMain) {
            const inputId = isMain ? 'igdb_main_id' : 'igdb_specific_id';
            const igdbId = document.getElementById(inputId).value;

            if (!igdbId) {
                showNotification('Please enter an IGDB ID', 'error');
                return;
            }

            const data = {
                tab: 'igdb',
                igdb_id: parseInt(igdbId),
                is_main: isMain
            };

            showNotification('Updating IGDB data...');

            fetch(`/api/save/{{ pid }}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showNotification('IGDB data updated successfully! Reloading...');
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        showNotification('Error: ' + result.error, 'error');
                    }
                })
                .catch(error => {
                    showNotification('Error updating IGDB data: ' + error, 'error');
                });
        }

        // Initialize availabilities view
        renderAvailabilities();
    </script>

    <script>
        function openInVSCode(pid) {
            fetch(`/open_in_vscode/${pid}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Opened in VSCode!');
                    } else {
                        showNotification('Error: ' + data.error, 'error');
                    }
                })
                .catch(err => showNotification('Request failed: ' + err, 'error'));
        }
    </script>
</body>

</html>